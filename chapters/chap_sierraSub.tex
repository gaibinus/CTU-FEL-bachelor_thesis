
%%%%% BOARD SIERRA - SUBMODULES

\label[chap:boardSierraSubsystems]
\chap Board Sierra - subsystems

\quad In this chapter, we provide all details about the individual \glref{OBC} subsystems. We address one of them in each section. Firstly, we explain the importance of the subsystem in theory, and then we describe our approach and the design decisions we made. We also present and comment on each subsystem's electronics scheme design together with the design of its layout and tracing on the Board Sierra \glref{PCB}. For a better image of the overall location and layout of these OBC subsystems, refer to figure \ref[img:sierra_subsystems]. 

\circleparams={\ratio=1 \fcolor=\White \lcolor=\Black \hhkern=0.9pt \vvkern=0.9pt}

\midinsert
    \clabel[img:sierra_subsystems]{Sierra subsystems summary}
    \picw=1\hsize \cinspic figures/model/sierra_subsystems.pdf
    \caption/f Location and layout of the Board Sierra \glref{OBC} subsystems. The top side of the \glref{OBC} is displayed on the left, whereas the bottom side is on the right. Legend: {\typosize[8/]\incircle{⟨1⟩}} microcontroller, {\typosize[8/]\incircle{⟨2⟩}} external clock sources, {\typosize[8/]\incircle{⟨3⟩}} power management, {\typosize[8/]\incircle{⟨4⟩}} peripheral isolators, {\typosize[8/]\incircle{⟨5⟩}} triple-redundant FLASH memory, {\typosize[8/]\incircle{⟨6⟩}} triple-redundant F-ram memory, {\typosize[8/]\incircle{⟨7⟩}} \glref{CAN} bus transceivers, {\typosize[8/]\incircle{⟨8⟩}} onboard temperature sensors, and {\typosize[8/]\incircle{⟨9⟩}} \glref{SWD} connector and  circuitry.
\endinsert



%%%%% MICROCONTROLLER

\sec Microcontroller

\quad The processing unit is the most important part of the \glref{OBC}. Professional designs use \quad{MCU}s with a wide variety of instruction set architectures \cite[obc:dataPatterns, obc:imt, obc:pumpkin, obc:gauss, obc:nanosatpro]. However, the \glref{ARM} architecture seems to be the most popular \cite[obc:isis, obc:gos, obc:aac, obc:anteleope, obc:gom, obc:satbus]. This architecture is known for its good multiprocessing support, low power consumption, affordable pricing, and existing applications in various fields. Considering these benefits and influenced by the LibreCube initiative, existing TUDSaT's \glos{OBC} project, and most importantly the \glref{VST} supervisors, we decided to pick an STM32 microprocessor.

Our task was to choose a particular model of this 32-bit, Arm and Cortex-M based \glref{MCU}. Aiming rather for a low-power than high-performance characteristics, we decided to select an L series. Particularly the L4 series as it combines the largest flash memory size with the highest number of general-purpose input/output pins (\glref{GPIO}s) \cite[dat:mcuSeries]. Although, only one device from the L4 series is equipped with two CAN bus channels. As the presence of a second bus is crucial for our double-redundant approach, the STM32L496xx option was selected. This family comes in six different packages. Avoiding all of the \glref{BGA}-like ones (as described in section \ref[chap:additionalParams]) narrows the selection to Zx, Vx, and Rx variants. The Zx is the most capable one in terms of flash size and \glref{GPIO} count. Therefore the STM32L496ZG (where G stands for extended operating temperature range) was our final choice \cite[dat:mcu]. From now on, we will refer to this particular device as the \glref{MCU}. Some of its key characteristics are listed in table \ref[tab:microcontroller].

\midinsert \clabel[tab:microcontroller]{Microcontroller parameters}
    \ctable{lcc|lcc}{
        Max. frequency      & $80\;\rm{[MHz]}$            &&& \glref{SPI}     & $3$     \cr
        Flash memory        & $1\;\rm{[MB]}$              &&& \glref{$\rm{I^2C}$}     & $4$     \cr
        Static RAM          & $320\;\rm{[kB]}$            &&& \glref{UART}    & $5$     \cr
        Comparators         & $2$                         &&& \glref{CAN}     & $2$     \cr
        Op. amplifiers      & $2$                         &&& \glref{GPIO}    & $115$   \cr
        Operation temp.     & $-40$ to $125\;\rm{[°C]}$   &&& \glref{DAC}     & $2$
    }
    \caption/t Highlighted characteristics of the STM32L469ZG microcontroller \cite[dat:mcu].
\endinsert

\secc Schematic design

\quad The \glref{MCU} pin assignment was continuously changing during the entire process of \glref{OBC} schematic and PCB design. Its final state is presented in figure \ref[app_sch:microcontroller]. We attempted to maximize the number of user-free \glref{GPIO}s with added functionalities such as \glref{ADC} or \glref{PWM} while keeping the fanout manageable. A significant help during this process was the CubeMX tool of the STM32CubeIde, visualizing all of the pinout combinations with a specific functionality. Each of the $3.3\rm{[V]}$ tolerant pins was used only for the internal circuitry, resulting in a fully $5\rm{[V]}$ tolerant main PC104 header connection.

A significant number of filtering and reservoir capacitors is needed to ensure the proper \glref{MCU} functionality. The assignment of correct capacitors to required \glref{MCU} pins was pretty straightforward, following the device datasheet \cite[dat:mcu] and STM32L4 hardware development application note \cite[app:getStart]. Furthermore, a $10\rm{[\mu H]}$ choke and $120\rm{[\Omega]}$ at $100\rm{[MHz]}$ ferrite bead were placed in series with the analog power input. This \glref{LC} filter supported by the bead should effectively eliminate both low and high-frequency interference.

The clock and data lines of both \glref{$\rm{I^2C}$} busses are equipped with standard $4.7\rm{[k\Omega]}$ resistors. Multiple $22\rm{[\Omega]}$ resistors were placed in series with high-speed clock signals of the \glref{SPI} interface. Two $0\rm{[\Omega]}$ resistors are present on {\it FAULT} and {\it MODE} lines to facilitate an optional hardware isolation. A $10\rm[k\Omega]$ resitor at {\it PH3} is suggested by \cite[app:getStart].

\secc PCB design

\quad Location and fanout of the \glref{MCU} are shown in figure \ref[pcb:microcontroller]. The \glref{MCU} is placed on the \glref{PCB} top side, covering most of the non-payload area. This big footprint of a LQFP144 package (approximately $2$ x $2\rm{[cm]}$) is a consequence of avoiding the \glref{BGA} packages while still trying to keep the pin count high. All of the capacitors were placed as close to their assigned pins as possible. In some cases, it was necessary to use the bottom side of the \glref{PCB}. The same approach was applied to all of the resistors. A hole of $1.2\rm{[mm]}$ diameter is placed roughly at the middle of the \glref{MCU} footprint. The diameter was set to fit a 19 gauge needle attached to a syringe with epoxy. This epoxy glue should be filled through this hole into the void space between the \glref{PCB} and the \glref{MCU}. This procedure is typical for space applications. Its purpose is to add some mechanical robustness to the LQFP device and create a thermal bridge between the \glref{PCB} and the devices.

\midinsert
    \clabel[pcb:microcontroller]{Microcontroller circuitry}
    \picw=0.85\hsize \cinspic figures/pcbs/microcontroller.pdf
    \caption/f Highlighted location of microcontroller circuitry.
\endinsert



%%%%% EXTERNAL CLOCK SOURCES

\sec External clock sources

\quad Proper timing and synchronization are the key features while dealing with high-speed data busses, \glref{ADC}s, or other precise applications. The \glref{MCU} is equipped with two internal \glref{RC} oscillators that can be used to drive a master system clock and other auxiliary clocks \cite[dat:mcu]. These internal oscillators generally have a significantly lower frequency stability,  a higher temperature dependency, and smaller overall accuracy than their external equivalents \cite[app:oscInt]. Therefore, to increase the clock precision and reliability in the harsh space environment, we had to implement external clock sources.

A $4-48\rm{[MHz]}$ high speed external oscillator (\glref{HSE}) can drive the system clock. Supported types are crystal, ceramic resonator, or silicone oscillator \cite[dat:mcu]. The last option seems to be the best as it is insensitive to electromagnetic interference (\glref{EMI}) and vibration. The only downside is its slightly lower temperature rejection \cite[app:oscComp]. We chose the SiT8924B, a $26\rm{[MHz]}$ silicon microelectromechanical system (\glref{MEMS}) oscillator \cite[dat:hse]. Accordingly to the clock configuration tool of the stm32cube software, we can reach various system clock and auxiliary clocks frequencies up to $78\rm{[MHz]}$ (maximum is $80\rm{[MHz]}$ \cite[dat:mcu]). This is done using the phase-locked loop (\glref{PLL}) clock generation.

A $32.768\rm{[kHz]}$ low speed external oscillator (\glref{LSE}) can drive the real time clock (\glref{RTC}), hardware auto calibration, or other timing functions \cite[dat:mcu]. Table 7 in \cite[app:oscDes] recommends individual crystal resonators for combination with STM32 \glref{MCU}s. After a consideration of these options, we decided to pick the ABS07AIG ceramic base crystal \cite[dat:lse].

\secc Schematic design

\quad The \glref{HSE} circuitry follows the oscillator datasheet \cite[dat:hse]  and is shown on the right side of figure \ref[sch:clockSources]. Only a decoupling capacitor and a terminator resistor are required. The clock output {\it OSE_IN} can be enabled or disabled by the binary {\it OSC_EN} signal.

 The \glref{LSE} circuitry is based on a reference design in the oscillator design guide \cite[app:oscDes]. To achieve a stable frequency of this Pierce oscillator, it is required to find the values of load capacitors $C_{L1}$, $C_{L2}$ and external resistor $R_{E}$. This can be done using equations
$$ C_L = {{C_{L1} C_{L2}}\over{C_{L1}} + C_{L2}} + C_S \quad \wedge \quad C_{L1} = C_{L2}, \eqmark $$
$$ R_{E} = {1\over{2\pi f C_{L2}}}, \eqmark $$
where $C_L$ is the crystal load capacitance, $f$ is the crystal oscillation frequency and $C_S$ is the stray capacitance \cite[app:oscDes]. Values of $C_L$ and $f$ are listed in the crystal datasheet \cite[dat:lse]. We can assume as a rule of thumb, that $C_S=4\rm{[pF]}$. The final \glref{LSE} circuitry with computed values of the components is shown on the left side of figure \ref[sch:clockSources].

\midinsert
    \clabel[sch:clockSources]{Clock sources schematic}
    \picw=0.5\hsize \cinspic figures/schemes/clockSources.pdf
    \caption/f Schematic diagram of external clock sources.
\endinsert

\secc PCB design

\quad Location and fanout of the external clock circuitry are shown in figure \ref[pcb:clockSources]. All of the components are placed on the bottom side of the \glref{PCB}. The circuitry layout follows multiple tips presented in the oscillator design guide \cite[app:oscDes]. Separate \glref{GND} planes are assigned to both the \glref{HSE} and \glref{LSE} circuitry. These planes are bounded by guard rings, formed by series of vias. Each of the planes is connected to a common \glref{GND} only at one point. This approach provides proper \glref{EMI} shielding while reducing a ground loop effect. We also minimized the distance between the \glref{MCU} pins and both oscillators. All these measures combined should improve the clock generation stability and robustness.

\midinsert
    \clabel[pcb:clockSources]{Clock sources circuitry}
    \picw=0.85\hsize \cinspic figures/pcbs/clockSources.pdf
    \caption/f Highlighted location of external clock sources circuitry.
\endinsert



%%%%% POWER MANAGEMENT

\sec Power management

\quad The electric power subsystem (\glref{EPS}) is known to be the most vital subsystem of a spacecraft \cite[pap:failRate2012, pap:failRate2014]. Its reliability and error handling should be ensured by the power control and distribution unit (\glref{PDCU}). However, it is a good practice by professional manufacturers to include an additional power monitoring and control to their \glref{OBC} design \cite[obc:dataPatterns, obc:isis, obc:imt, obc:gos, obc:pumpkin, obc:gauss, obc:aac, obc:anteleope, obc:nanosatpro, obc:gom, obc:satbus]. We have to implement circuitry that can sense a power bus malfunction and, as a response, power down the \glref{OBC}. This feature is also beneficial for some of the \glref{OBC} on-earth user cases. During a hardware development or a presentation, the user might misconnect the power line or use an unsupported power source by a mistake.

\midinsert
    \clabel[dia:powerManagement]{Power management diagram}
    \picw=0.75\hsize \cinspic figures/diagrams/powerManagement.pdf
    \caption/f Functional diagram of power management circuitry.
\endinsert

A functional diagram of the implemented power management is shown in figure \ref[dia:powerManagement]. To increase the overall efficiency and decrease complexity, we decided to avoid any voltage conversion independent from the \glref{PDCU}. Therefore, our \glref{OBC} requires two separate inputs from the main power buss ($3.3\rm{[V]}$ and $5\rm{[V]}$). The \glref{OBC} is connected to each of these inputs through an electronic fuse (\glref{eFuse}). This device continuously monitors the bus for events of under-voltage, over-voltage, and over-current\fnote{This is a crucial feature in handling and resolving a latch-up event.}. As a response to such an event, the \glref{eFuse} will switch into high impedance and pull down specific input of an AND logic gate. This gate simultaneously controls two load switches, one for each power line. This approach ensures that a fault on one power bus will result in a high impedance of both \glref{OBC} power inputs. It also eliminates the risk of a death loop, in which a reset of \glref{eFuse}s is not possible as they are switching each other off. Added benefits of this design are an inbuild current measurement and a Kill Switch integration into the logic gate. A summary of the final power management rating is listed in table \ref[tab:powerManagement]. These values were chosen considering the power requirements of the remaining \glref{OBC} components and are a subject of change by a future user.

\midinsert \clabel[tab:powerManagement]{Power management rating}
    \ctable{lccccc}{
        Power input                 & Parameter & Min & Typ & Max & Unit        \crl
        \vspan2{$3.3\rm{[V]}$ BUS}  & voltage   & 2.9 & 3.3 & 3.5 & $\rm{V}$    \cr
                                    & current   & 0.0 & -   & 1.2 & $\rm{A}$    \crl
        \vspan2{$5\rm{[V]}$ BUS}    & voltage   & 4.6 & 5.0 & 5.4 & $\rm{V}$    \cr
                                    & current   & 0.0 & -   & 1.2 & $\rm{A}$
    }
    \caption/t \glref{OBC} power rating. Value out of range will cause a protective shutdown.
\endinsert

\label[secc:powerManagementSch]
\secc Schematic design

\quad An actual schematic diagram of power management circuitry is shown in figure \ref[sch:powerManagement]. The most important part of this design is the \glref{eFuse}, as it covers all of the power control features. We decided to use the TPS25940-Q1 device \cite[dat:efuse]. Custom  threshold values can be set following the typical application schematic in the datasheet \cite[dat:efuse]. This is done by connecting specific resistors, with values calculated using the TPS2594x design calculation tool \cite[app:tps2594Calc]. As the logic AND gate, we chose the 74LVC1G11-Q100 \cite[dat:gate]. This device is designed to operate in a mixed logic level environment, what corresponds with our application. The last important component is the load switch. In our case, the TPS22965W-Q1 with an inbuilt output discharge function \cite[dat:switch]. For a correct operation of the switch, the {\it VBIAS} pin should stay saturated for a while after disconnecting the {\it VIN} voltage. We achieved this behavior by charging a capacitor connected to the {\it VBIAS} from the {\it VIN} through a Schottky diode. Four reservoir capacitors are placed on both sides of the load switches, following the suggestions in both datasheets \cite[dat:efuse, dat:switch]. Nominal logic values of all switching signals are set by pull-up or pull-down resistors.

\midinsert
    \clabel[sch:powerManagement]{Power management schematic}
    \picw=0.95\hsize \cinspic figures/schemes/powerManagement.pdf
    \caption/f Schematic diagram of power management circuitry.
\endinsert

\secc PCB design

\quad Location and fanout of the power management circuitry are shown in figure \ref[pcb:powerManagement].  All of the power management components are placed on the top side of the \glref{PCB}. Similarly, all of the power tracks are on the top copper layer. Only a few signal traces are running within the second or the bottom layer. Both the $3.3\rm{[V]}$ and $5\rm{[V]}$ control circuitry share the same layout and tracing regarding recommendations presented in the \glref{eFuse} and load switch datasheets \cite[dat:efuse, dat:switch]. The $3.3\rm{[V]}$ part is situated closer to the main PC104 header, while the $5\rm{[V]}$ part is right below it. Both \glref{eFuse}s are connected to the main PC104 header power pins through strengthened $0.77\rm{[mm]}$ traces in the third copper layer. Considering a standard copper thickness of $35\rm{[\mu m]}$, each of the input traces is rated to deliver up to $2\rm{[A]}$ of current. The logic gate with associated pull-down resistors is located above all of the remaining circuitry, closest to the main PC104 header.

\midinsert
    \clabel[pcb:powerManagement]{Power management circuitry}
    \picw=0.85\hsize \cinspic figures/pcbs/powerManagement.pdf
    \caption/f Highlighted location of power management circuitry.
\endinsert



%%%%% PERIPHERAL ISOLATORS

\sec Peripheral isolators

\quad The spacecraft \glref{OBC} is connected to many data buses shared among all other CubeSat submodules. In some scenarios, the \glref{OBC} must be able to isolate itself from a specific or multiple data buses. For example, to switch between \glref{OBC}s in a redundant configuration, to handle a failure on a data bus, or to prevent unintentional interference. Standard approaches to address this feature are based on using analog switches \cite[the:wurzburg], optocouplers \cite[pap:satelliteLeo], or \glref{FPGA}s \cite[obc:dataPatterns]. Furthermore, these isolators should also guarantee that all data lines are in a high impedance state when the \glref{OBC} is powered off.

After a brief survey, we decided to implement the design using robust analog switches. This approach is more straightforward, less expensive, and requires a smaller \glref{PCB} area than the optocoupler or the \glref{FPGA}-based ones. A functional diagram of the implemented circuity is shown in figure \ref[dia:peripheralIsolators]. All of the \glref{OBC} data lines are connected to the rest of the spacecraft through a series of analog switches. These data lines are grouped by particular data buses and are assigned to a separate switch. The \glref{OBC} can enable or disable a specific switch and therefore isolate a particular data bus from the remaining spacecraft subsystems. Pulling low the Kill Switch will result in high impedance of all switches and completely isolating the \glref{OBC} data lines.

\midinsert
    \clabel[dia:peripheralIsolators]{Peripheral isolators diagram}
    \picw=0.8\hsize \cinspic figures/diagrams/peripheralIsolators.pdf
    \caption/f Functional diagram of peripheral isolators circuitry.
\endinsert

\secc Schematic design

\quad Schematic diagrams of two isolators are shown in figure \ref[sch:peripheralIsolators]. We decided to use the DGQ2788A device \cite[dat:isolator]. The \glref{OBC} hosts fifteen of these analog switches in a dual double pole double throw (\glref{DPDT}) configuration. The \glref{OBC} data lines are connected to common terminals ({\it COM}). Normally closed terminals ({\it NC}) are left floating, whereas normally open terminals ({\it NO}) terminals are connected to the spacecraft data lines. The important Kill Switch functionality is implemented using the device's power down protection. If the switch loses power, it will enter the normal state. This approach simplifies the circuitry a lot as it substitutes an otherwise necessary system of multiple logic gates. Other beneficial features of this analog switch are a high latch-up current of $300\rm{[mA]}$ and inbuild signal clamping. The device will clamp all of the signals exceeding its supply voltage by internal diodes. As the \glref{MCU} pins connected to these analog switches are $5\rm{[V]}$ tolerant, we chose to power the switches from the $5\rm{[V]}$ power bus. A malfunction could be caused by the switch's enable terminals ({\it EN}), as they do not include internal pull-up or pull-down resistors. We decided to use external pull-down ones to avoid the enable signals' floating state and avoid unintentional device switching. The decoupling capacitors were placed accordingly to the device datasheet. 

\midinsert
    \clabel[sch:peripheralIsolators]{Peripheral isolators schematic}
    \picw=0.92\hsize \cinspic figures/schemes/peripheralIsolators.pdf
    \caption/f Schematic diagram of two peripheral isolators.
\endinsert

\label[secc:peripheralIsolatorsPCBDesign]
\secc PCB design

\quad Location and fanout of the isolators circuitry are shown in figure \ref[pcb:peripheralIsolators]. Sixty separate signals are running from the \glref{MCU} pins through analog switches up to assigned pins in the PC104 header. Hence this part of the \glref{PCB} was the most challenging to design. The switches are placed in two main rows, each on one side of the \glref{PCB} (only two switches are not aligned). The position of every switch was determined by its assigned \glref{MCU} and PC104 header pins. It took several iterations to find out the current layout. The routing network is quite dense, using all three copper signal layers. To accommodate all of the signal traces, the standard signal trace width was decreased from $200\rm{[\mu m]}$ to $173\rm{[\mu m]}$. This new value was acquired as a maximal width possible to squeeze three traces between two pins of the PC104 header. To ensure \glref{CAN} buses signal integrity, we addressed a length matching of its differential pairs. As a finishing step of the routing, lengths of separate \glref{CAN} traces were measured and tuned with serpentine patterns.

\midinsert
    \clabel[pcb:peripheralIsolators]{Peripheral isolators circuitry}
    \picw=0.85\hsize \cinspic figures/pcbs/peripheralIsolators.pdf
    \caption/f Highlighted location of peripheral isolators circuitry.
\endinsert



%%%%% EXTERNAL MEMORY

\sec External memory

\quad One of the \glref{OBC}'s important tasks is collecting and processing data from other submodules present in the spacecraft. As this payload and housekeeping communication might generate a wide data flow, external memory storage is usually dedicated to the \glref{MCU} \cite[obc:dataPatterns, obc:isis, obc:imt, obc:gos, obc:pumpkin, obc:gauss, obc:aac, obc:anteleope, obc:nanosatpro, obc:gom, obc:satbus]. This secondary memory should be writable, preferably fast, and non-volatile (can retain the stored information after power off) to support quick buffering and permanent data storage. Commonly used semiconductor memory technologies matching the criteria are EPROM, EEPROM, FLASH, and various NVRAMs. 

A great threat to memory storage is space radiation, as presented in chapter \cite[chap:radiationAndRedundancy]. In a single event upset (SEU), the storage node charge in memory is upset due to particle strike and change its logic level \cite[pap:radiationSurvey]. This effect results in random bit-flips throughout the memory address space, corrupting the stored information. Approaches handling this damage are based on i) more durable or even rad-hard memory \glref{IC}s, ii) triple modular redundancy, and iii) error detecting and correcting codes. As the last approach is a software implementation, only the first two could be used in our design.

The EPROM and EEPROM memories are not a good candidate for the \glref{OBC}, as they proved to be more sensitive to gamma radiation \cite[pap:memoryDamage]. The same applies to MRAM, as these memories are generally sensitive to single event effects (SEE) \cite[pap:mramSurvey]. On the other hand, the cell of fairly popular FLASH devices proved to be robust against SEU because more energy is required to change the state of a bit. FLASH memories are more tolerant to radiation and are a good candidate for vital data and code \cite[boo:framInSpace]. F-RAM is a technology that combines the best of Flash and SRAM. It offers faster writes, high read-write cycle endurance, and very low power consumption \cite[pap:ramSurvey]. Moreover, the F-RAM memories have excellent tolerance to radiation \cite[boo:framInSpace]. Considering the listed aspects of radiation effects rejection, together with speed and power consumption, we decided to include both FLASH and F-RAM memories in our \glref{OBC} design. The final parameters of the external memory subsystems are listed in table \ref[tab:externalMemory].

\midinsert \clabel[tab:externalMemory]{External memory parameters}
    \ctable{llll}{
        Subsystem   & Size              & Max. clock        & SPI connection        \crl
        FLASH       & 3x $32\rm{[MB]}$  & $133\rm{[MHz]}$   & SIO, DIO, QIO, QPI    \cr
        F-RAM       & 3x $2\rm{[Mb]}$   & $25\rm{[MHz]}$    & SIO, QIO
    }
    \caption/t Parameters of the external memory subsystems.
\endinsert

\secc Schematic design

\quad Schematic diagrams of FLASH (left) and F-RAM (right) memory subsystems are shown in figure \ref[sch:externalMemory]. Triple modular redundancy is achieved in both of them by connecting three of the same memory \glref{IC}s to one shared data bus. The \glref{MCU} can separately enable or disable a particular \glref{IC} throughout its chip select (\textit{CS}) pin. External pull-up resistors added to these selection lines set the disable mode as a default one. 

As a FLASH memory, the S25FL256L device was selected \cite[dat:flash]. The \glref{SPI} interface of this $32\rm{[MB]}$ NOR memory (also available in $16\rm{[MB]}$ version) can operate in single, dual, or four-bit wide signal lines and also supports the quad peripheral interface (\glref{QPI}) commands. For the F-RAM device, we chose the CY15B102Q \cite[dat:fram]. This $2\rm{[Mb]}$ memory supports a dual or four-bit wide \glref{SPI} interface. The $100\rm{[nF]}$ decoupling capacitors connected to the power inputs of the memory \glref{IC}s were suggested by both devices datasheets. Additionally, a test point was placed on each signal line of both \glref{SPI} data buses. This addition may improve the potential debugging of these subsystems.

\midinsert
    \clabel[sch:externalMemory]{External memory schematic}
    \picw=1\hsize \cinspic figures/schemes/externalMemory.pdf
    \caption/f Schematic diagram of external memory circuitry. 
\endinsert

\secc PCB design

\quad Locations and fanout of external memory circuitry are shown in figure \ref[pcb:ExternalMemory]. Devices of the FLASH subsystem are located at the top side of the \glref{PCB}, below the \glref{MCU}. Devices of the F-RAM subsystem are located at the bottom side of the \glref{PCB}, right from the \glref{MCU}. This device is the only one in the entire \glref{OBC} design with a non-fine pitch package. All of the \glref{SPI} test pads are placed from the bottom side of the \glref{PCB}.

\midinsert
    \clabel[pcb:ExternalMemory]{External memory circuitry}
    \picw=0.85\hsize \cinspic figures/pcbs/externalMemory.pdf
    \caption/f Highlighted location of external memory circuitry.
\endinsert



%%%%% CAN BUS DRIVERS

\sec CAN bus drivers

\quad The high-speed SpaceCAN is considered a primary control and monitoring bus of a LibreCube spacecraft. Therefore it was required to ensure its full support by the \glref{OBC}. An external \glref{CAN} transceiver is usually added to a microcontroller, as its internal physical layer has only limited properties or does not even exists. The separate transceiver provides a stable and reliable physical environment. In our case, the \glref{MCU}'s BxCAN is compatible with both 2.0A and 2.0B \glref{CAN} specifications with a bit rate up to $1\rm{[MB\,s^{-1}]}$ \cite[dat:mcu]. As the \glref{MCU}'s \glref{CAN} drivers are equipped with the 2nd network layer only, an external transceiver implementation to our design was required.

\secc Schematic design

\quad A schematic diagram of implemented \glref{CAN} driving circuitry is shown in figure \ref[sch:canBusDrivers]. As the \glref{MCU} supports two independent \glref{CAN} busses, we had to accommodate each of them. For the \glref{CAN} transceiver, we decided to use a TCAN1051V-Q1 device \cite[dat:canDriver]. The \glref{Rx/Tx} lines of the \glref{MCU} are connected to the device with a $22\rm{[\Omega]}$ terminating resistors. A test point is also present on each of these lines to assist potential debugging. This version of the device comes with a level shifting feature. Different voltage levels on \glref{CAN} and \glref{Rx/Tx} sides are supported. Since the SpaceCAN is a $5\rm{[V]}$ bus and the \glref{MCU} operates at $3.3\rm{[V]}$, we set the device's power levels accordingly. As recommended in the device datasheet, decoupling capacitors were added to power pins. Considering the \glref{CAN} bus's importance, we expect it to stay active straight from powering on the \glref{OBC}. To save some complexity and \glref{MCU} pins,  we decided to ignore the option of controlling the device standby mode. A pull-down resistor on the {\it STBY} pin forces an active mode.

A well-designed \glref{CAN} network usually contains a terminating resistor, filtering, and a transient \& \glref{ESD} protection. To correctly implement these optional features, we followed application reports \cite[app:canDesign, app:canChokes]. Instead of a simple $120\rm{[\Omega]}$ terminating resistor, we chose a more advanced terminating node. A difference is in added filtering as the node consists of two $60\rm{[\Omega]}$ series resistors connected to a \glref{GND} through a $4.7\rm{[nF]}$ capacitor. Furthermore, $100\rm{[pF]}$ filtering capacitors were added to signal lines. Recognizing the suggestions in the reports, we did not include any common-mode chokes or \glref{ESD} protection in our design. Since our \glref{OBC} is not intended to operate near heavy machinery, no extra improvement of susceptibility to electromagnetic disturbance or \glref{EMC} is required.

\midinsert
    \clabel[sch:canBusDrivers]{CAN drivers schematic}
    \picw=0.62\hsize \cinspic figures/schemes/canDrivers.pdf
    \caption/f Schematic diagram of CAN bus driving circuitry.
\endinsert

\secc PCB design

\quad Location and fanout of the \glref{CAN} bus driving circuitry are shown in figure \ref[pcb:canDrivers]. The transceivers are placed on the \glref{PCB} top side in two different locations. Prioritizing the \glref{PCB} surface's optimal usage,  we were unable to keep the devices in a mutual area. The transceiver circuitry layout follows suggestions in the datasheet \cite[dat:canDriver] and the application report \cite[app:canDesign]. This layout is the same for both devices. As mentioned in section \ref[secc:peripheralIsolatorsPCBDesign], serpentine patterns were used to match trace lengths of particular differential pairs.

\midinsert
    \clabel[pcb:canDrivers]{CAN drivers circuitry}
    \picw=0.85\hsize \cinspic figures/pcbs/canDrivers.pdf
    \caption/f Highlighted location of CAN bus drivers circuitry.
\endinsert



%%%%% TEMPERATURE MONITORING

\sec Temperature monitoring

\quad Temperature is a critical parameter in the space environment, and all electronic components are sensitive to its variation. Any increase in temperature may reduce their lifespan and even result in irreversible damage. Such a temperature increase can be evoked by an ambient temperature or by the component's activity. Most electronic components are designed to dissipate heat into the ambient air. This is problematic in the space due to its lack of an atmosphere. Instead, a component transfers heat into the \glref{PCB}'s thermal capacity.\fnote{And then dissipated into the spacecraft environment by the thermal radiation \cite[pap:tempModeling].} This conduction can produce temperature gradients throughout the \glref{PCB} and influence other components. Furthermore, a change in a component's temperature can indicate its malfunction. Sudden temperature increase is a common sign of a latch-up event \cite[app:badBoys]. Accordingly, the \glref{OBC} temperature is a valuable part of a spacecraft telemetry and worthy of monitoring. Professional manufacturers have also included temperature sensors into their \glref{OBC} \cite[obc:dataPatterns, obc:isis, obc:imt, obc:gauss, obc:gom, obc:satbus].

Standard temperature sensor technologies include integrated circuit (\glref{IC}) sensors, thermistors, resistance temperature detectors (\glref{RTD}s), and thermocouples. Their key features are compared in the guide to temperature sensing \cite[boo:temperature]. The \glref{IC} sensors appeared to be the best choice for our design challenge. These sensors are typical for their good accuracy, small footprint, easy complexity, and excellent linearity. A processing unit can usually communicate with the \glref{IC} sensors using one shared data bus and receive ready-to-use temperature data. In contrast, the implementation of the other sensor technologies requires extra analog components and circuitry. For example, amplifiers and \glref{ADC}s for thermistors and thermocouples or precise current sources and \glref{ADC}s for \glref{RTD}s. These non-\glref{IC} technologies would also use multiple \glref{MCU} pins and require additional calibration and shielding. As our goal was to design a compact PCB and a simple system, we decided to implement the \glref{IC} sensors approach.

\secc Schematic design

\quad A schematic diagram of a temperature sensor network is shown in figure \ref[sch:temperatureMonitoring]. After a brief survey, we selected a MCP9804 device \cite[dat:temperature]. This temperature sensor has an accuracy of $\pm0.25\rm{[{^\circ C}]}$ and communicates through an $\rm{I^2C}$ interface. The device offers eight different $\rm{I^2C}$ addresses, selected by different logic levels on three slave address pins ({\it A0-A2}). Thanks to this feature, we were able to use only one $\rm{I^2C}$ bus for all of the devices. The final address assignment to particular sensors is listed in table \ref[tab:temperatureMonitoring]. As the temperature monitoring is continuous, we decided not to use the device's inbuild alter function. Placement of a decoupling capacitor and $10\rm{[k\Omega]}$ pull-up resistors on $\rm{I^2C}$ lines were suggested by the device datasheet. It is worth mentioning that this sensor supports a low-power standby mode, accessible through a special register.

\midinsert \clabel[tab:temperatureMonitoring]{Temp. sensors description}
    \ctable{cclcc}{
        Designator  & \mspan2[l]{Targeted component}    & Slave addr.   & \glref{$\rm{I^2C}$} addr. \crl
        TS1         & M2  & - Flash memory              & $000$         & $0\rm{x}18$       \cr
        TS2         & U1  & - \glref{MCU}, central west & $100$         & $0\rm{x}1C$       \cr
        TS3         & EF2 & - $5\rm{[V]}$ eFuse         & $001$         & $0\rm{x}19$       \cr
        TS4         & U1  & - \glref{MCU}, north east   & $110$         & $0\rm{x}1E$       \cr
        TS5         & U3  & - \glref{CAN}2 driver       & $010$         & $0\rm{x}1A$       \cr
        TS6         & EF1 & - $3.3\rm{[V]}$ eFuse       & $011$         & $0\rm{x}1B$       \cr
        TS7         & U2  & - \glref{CAN}1 driver       & $111$         & $0\rm{x}1F$       \cr
    }
    \caption/t List of temperature sensors location and addresses.
\endinsert

Accordingly to the survey on CubeSat electrical bus reliability \cite[pap:reliability], the $\rm{I^2C}$ interface is the most likely to fail. Over half of investigated spacecrafts experienced at least one $\rm{I^2C}$ lockup\fnote{A continuous busy state of the $\rm{I^2C}$ bus, where is the master prevented from starting a new transaction.}. Hence it was essential to apply measures assuring the proper functionality of our $\rm{I^2C}$ based temperature monitoring network. We had to implement a mechanism that can either prevent the lockup from occurring or is capable of resolving it. We chose the second option, as we consider it as a more robust and reliable. A simple but efficient approach to resolve an $\rm{I^2C}$ lockup is to reset the power of all its slave devices. For this purpose, we implemented the TPS22965W-Q1 load switch in the very same configuration as we have used in the power management circuitry (subsection \ref[secc:powerManagementSch]).

\midinsert
    \clabel[sch:temperatureMonitoring]{Temp. monitoring schematic}
    \picw=1.0\hsize \cinspic figures/schemes/temperatureMonitoring.pdf
    \caption/f Schematic diagram of temperature monitoring circuitry.
\endinsert

\secc PCB design

\quad The layout of the temperature monitoring circuitry is dependent on the other subsystems. Therefore, it had to be implemented as the very last one. Each of the \glref{IC} sensors was assigned to monitor a temperature of a particular device from another subsystem. These monitored devices were carefully chosen to cover all of the \glref{OBC}'s most critical components. These are various \glref{IC}s used in the other subsystems as they execute multiple tasks, produce most of the heat, and are vulnerable to latch-up events. A listing of the monitored devices and their assigned temperature sensors is stated in table \ref[tab:temperatureMonitoring].

As we cannot exceed a total number of eight \glref{IC} temperature sensors (MCP9804 devices) at one $\rm{I^2C}$ bus, we decided to monitor only one of the three FLASH devices. We selected the one in the middle as a good approximation of the two remaining FLASH devices. None of the three F-ram devices is monitored directly as the opposite side of the \glref{PCB} in their location contains a dense layout of the power management circuitry. However, the F-ram devices are neighbored by three temperature sensors: TS5, TS6, and TS3. Measurements obtained from these sensors should be sufficient to monitor the F-ram devices. The \glref{MCU} contains an inbuilt temperature sensor suitable only for applications that detect temperature changes only \cite[dat:mcu]. We decided to monitor the \glref{MCU} with a pair of \glref{IC} sensors as we prefer to measure the absolute temperature.

To ensure correct temperature measurement, we have to create a sufficient thermal bridge between the temperature sensor and its targeted device. A common approach is to place the sensor on the other side of the \glref{PCB}, right opposite the device. A thermal bridge is then created using a set of \glref{PCB} vias. This method is recommended and described in the temperature sensors guideline for \glref{SMD}s \cite[app:temperature]. Its illustration for our use case is shown in figure \ref[dia:temperatureMonitoring]. It is worth mentioning that the added vias help dissipate the heat into the \glref{PCB} and are usually required by the device's datasheet.

\circleparams={\ratio=1 \fcolor=\White \lcolor=\Black \hhkern=0.9pt \vvkern=0.9pt}

\midinsert
    \clabel[dia:temperatureMonitoring]{Thermal bridge illustration}
    \picw=0.8\hsize \cinspic figures/diagrams/temperatureMonitoring.pdf
    \caption/f Illustration of a thermal bridge between the temperature sensor and WSON package (left) or LQFP package (right). Legend: {\typosize[8/]\incircle{⟨1⟩}} 6-layer \glref{PCB}, {\typosize[8/]\incircle{⟨2⟩}} targeted device, {\typosize[8/]\incircle{⟨3⟩}} \glref{IC} temperature sensor, {\typosize[8/]\incircle{⟨4⟩}} measurement die, {\typosize[8/]\incircle{⟨5⟩}} via, {\typosize[8/]\incircle{⟨6⟩}} thermal pad, {\typosize[8/]\incircle{⟨7⟩}} epoxy resin.
\endinsert

Location and fanout of the temperature monitoring circuitry are shown in figure \ref[pcb:temperatureMonitoring]. All \glref{IC} sensors are placed at the bottom side of the \glref{PCB}, directly under their targeted devices. The load switch is located at the \glref{PCB}'s west-central part. The switch itself and most of its auxiliary components are placed on the top side of the \glref{PCB}. The $\rm{I^2C}$ bus signal traces and separate power bus runs between all of the sensors.

\midinsert
    \clabel[pcb:temperatureMonitoring]{Temp. monitoring circuitry}
    \picw=0.85\hsize \cinspic figures/pcbs/temperatureMonitoring.pdf
    \caption/f Highlighted location of temperature monitoring circuitry.
\endinsert



%%%%% DEBUG CONNECTOR

\sec Debug connector

\quad A host/target interface is required to program or debug the \glref{MCU}. This interface is made of three components. A hardware debug tool, an \glref{SWJ} connector and a cable connecting the host to the debug tool \cite[app:getStart]. As the \glref{SWJ} connector is a part of the target board, we had to implement it into our \glref{PCB} design. The MCU has an embedded \glref{SWJ-DP} interface that enables either a serial wire debug (\glref{SWD}) or a \glref{JTAG} probe to be connected to the target \cite[dat:mcu]. Considering that the \glref{SWD} is required by the ST-LINK, is performed using two pins (five needed for the \glref{JTAG}), and is the preferred debug port \cite[app:debugToolbox], we decided to implement the \glref{SWD} only. This decision slightly decreased the \glref{PCB} complexity and freed some \glref{MCU} pins for further usage. Also, the Sierra Board was not created with a mass production indent, the primary use case of the \glref{JTAG} debug.

The implemented \glref{SWD} connector includes not only the two mandatory SWDIO and SWCLK pins. An NRST signal is also presented, enabling a connection under reset. This signal is required to take back the control of the board when it is not responding \cite[app:debugToolbox]. Also, a serial wire output (SWO) is available, providing an asynchronous serial communication channel. It has to be used in combination with a serial wire viewer (SWV) \cite[app:debugToolbox]. Additionally, one UART channel is also presented, providing a convenient communication option for the development and testing process. Pin assignment of the ST-LINK compatible connector of the Board Sierra is shown in figure \ref[mod:programPort].

\midinsert
    \clabel[mod:programPort]{Debug connector pinout}
    \picw=0.45\hsize \cinspic figures/model/programPort.pdf
    \caption/f Debug connector pinout.
\endinsert

\secc Schematic design

\quad The programing connector is intended to be in direct touch with external hardware and human manipulation. As suggested in the application report \cite[app:badBoys], we decided to protect the associated signals against the \glref{ESD}. A \glref{TVS} diode array SP3012-06 \cite[dat:esd] was selected, as it provides the exact pin count as needed. All of the debugging \glref{MCU} signals were routed through this low-capacitance \glref{ESD} protection device. A schematic diagram of the circuitry is shown in picture \ref[sch:programPort]. Additionally, a $22\rm{[\Omega]}$ terminating resistor is connected in series to each signal. A $100\rm{[\Omega]}$ resistor and a ferrite bead are connected to the connector's power pin. Their purpose is to limit the transient current and suppresses high-frequency electronic noise that may affect the \glref{OBC} from an attached debugger.

\midinsert
    \clabel[sch:programPort]{Debug connector schematic}
    \picw=0.5\hsize \cinspic figures/schemes/programPort.pdf
    \caption/f Schematic diagram of debug connector circuitry.
\endinsert

\secc PCB design

\quad Location and fanout of the debug connector circuitry are shown in figure \ref[pcb:programPort]. A small $4$x$2$ female header with a $1.27\rm{[mm]}$ pitch was selected as a debug connector. Its placement near the edge of the PCB in a cutout area should improve its accessibility and cable management. This \glref{SMD} connector is located on the \glref{PCB}'s top side, while the remaining electronics parts are placed below it, from the bottom side of the \glref{PCB}.

\midinsert
    \clabel[pcb:programPort]{Debug connector circuitry}
    \picw=0.85\hsize \cinspic figures/pcbs/programPort.pdf
    \caption/f Highlighted location of debug connector circuitry.
\endinsert



%%%%% PAYLOAD SECTOR

\label[chap:sierra_payloadSector]
\sec Payload sector

\quad As mentioned in section \ref[chap:payloadSector], only one-fourth of the entire PCB surface is occupied by the OBC circuitry. The remaining space is meant to be used as a user-defined payload sector. After discussing with the VST supervisors, we utilized this sector as a universal prototyping board. We implemented this feature to illustrate the purpose of this sector - to accommodate any user-specific circuitry. We expect that a future user of the Board Sierra would replace the universal board with his mission-specific circuitry.

The design of the universal prototyping board is visible in figures \ref[app_vis:sierraTop] and \ref[app_vis:sierraBottom]. Its main feature is a grid of $0.85\rm{[mm]}$ wide THT holes with a plating utilized for an SMD soldering. This THT array is surrounded and divided by power bus rails, providing $5\rm{[V]}$, $3.3\rm{[V]}$, and GND connections. This power delivery is sourced directly from the main PC104 header, bypassing the power management circuitry. However, each of the rails is fused by a 1206 packaged ceramic fuse. In the lower part of the prototyping board, two universal SO-24 footprints are available on each PCB side for rapid prototyping. Every pad of these footprints is routed to a small circular pad for easier soldering.
